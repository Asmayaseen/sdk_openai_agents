from typing import List, Dict, Any, Optional, Tuple
from .base import BaseAgent
from context import UserSessionContext, AgentType

class HumanCoachAgent(BaseAgent):
    """Human coach connection and crisis support agent"""
    
    def __init__(self):
        super().__init__(AgentType.HUMAN_COACH)
        self.capabilities = [
            "Professional referrals",
            "Crisis support resources",
            "Complex case management",
            "Human coach connections",
            "Emergency intervention",
            "Specialized care coordination"
        ]
    
    async def process_message(self, message: str, context: UserSessionContext) -> str:
        """Process requests for human support"""
        message_lower = message.lower()
        
        # Handle different types of human support requests
        if any(word in message_lower for word in ['crisis', 'emergency', 'suicide', 'hurt myself']):
            return await self._handle_crisis_support(message, context)
        elif any(word in message_lower for word in ['therapist', 'counselor', 'psychologist', 'psychiatrist']):
            return await self._provide_mental_health_referrals(message, context)
        elif any(word in message_lower for word in ['doctor', 'physician', 'medical']):
            return await self._provide_medical_referrals(message, context)
        elif any(word in message_lower for word in ['nutritionist', 'dietitian']):
            return await self._provide_nutrition_referrals(message, context)
        elif any(word in message_lower for word in ['trainer', 'coach', 'fitness professional']):
            return await self._provide_fitness_referrals(message, context)
        else:
            return await self._handle_general_human_support(message, context)
    
    async def _handle_crisis_support(self, message: str, context: UserSessionContext) -> str:
        """Handle crisis situations with immediate resources"""
        response = "üö® IMMEDIATE CRISIS SUPPORT\n\n"
        response += "üÜò **If you're in immediate danger, please contact emergency services: 911**\n\n"
        
        response += "üìû **24/7 Crisis Resources**:\n\n"
        response += "üá∫üá∏ **United States**:\n"
        response += "‚Ä¢ **National Suicide Prevention Lifeline**: 988\n"
        response += "  - Available 24/7, free and confidential\n"
        response += "  - Chat online at suicidepreventionlifeline.org\n\n"
        
        response += "‚Ä¢ **Crisis Text Line**: Text HOME to 741741\n"
        response += "  - Free, 24/7 crisis support via text\n"
        response += "  - Trained crisis counselors available\n\n"
        
        response += "‚Ä¢ **National Domestic Violence Hotline**: 1-800-799-7233\n"
        response += "  - 24/7 support for domestic violence situations\n\n"
        
        response += "‚Ä¢ **SAMHSA National Helpline**: 1-800-662-4357\n"
        response += "  - Mental health and substance abuse support\n"
        response += "  - Treatment referral and information service\n\n"
        
        response += "üåç **International Resources**:\n"
        response += "‚Ä¢ **Canada**: Talk Suicide Canada - 1-833-456-4566\n"
        response += "‚Ä¢ **UK**: Samaritans - 116 123\n"
        response += "‚Ä¢ **Australia**: Lifeline - 13 11 14\n"
        response += "‚Ä¢ **International**: befrienders.org\n\n"
        
        response += "üè• **Immediate Steps**:\n"
        response += "1. **Stay Safe**: Remove any means of self-harm\n"
        response += "2. **Reach Out**: Call one of the numbers above\n"
        response += "3. **Stay Connected**: Don't isolate yourself\n"
        response += "4. **Go to ER**: If in immediate physical danger\n"
        response += "5. **Tell Someone**: Inform a trusted friend or family member\n\n"
        
        response += "üíô **Remember**:\n"
        response += "‚Ä¢ You are not alone in this\n"
        response += "‚Ä¢ Crisis feelings are temporary\n"
        response += "‚Ä¢ Help is available and effective\n"
        response += "‚Ä¢ Your life has value and meaning\n"
        response += "‚Ä¢ Many people have felt this way and recovered\n\n"
        
        response += "ü§ù **Next Steps After Crisis**:\n"
        response += "‚Ä¢ Follow up with a mental health professional\n"
        response += "‚Ä¢ Create a safety plan with support people\n"
        response += "‚Ä¢ Consider intensive outpatient programs\n"
        response += "‚Ä¢ Build a strong support network\n"
        
        # Log this as a critical interaction
        context.add_conversation(message, "Crisis support provided", "emergency_intervention")
        
        return response
    
    async def _provide_mental_health_referrals(self, message: str, context: UserSessionContext) -> str:
        """Provide mental health professional referrals"""
        response = "üß† Mental Health Professional Referrals\n\n"
        
        response += "üéØ **Types of Mental Health Professionals**:\n\n"
        response += "1. **Psychologist (PhD/PsyD)**:\n"
        response += "   - Provides therapy and psychological testing\n"
        response += "   - Cannot prescribe medication (in most states)\n"
        response += "   - Specializes in various therapy approaches\n\n"
        
        response += "2. **Psychiatrist (MD)**:\n"
        response += "   - Medical doctor specializing in mental health\n"
        response += "   - Can prescribe medication\n"
        response += "   - Often focuses on medication management\n\n"
        
        response += "3. **Licensed Clinical Social Worker (LCSW)**:\n"
        response += "   - Provides therapy and counseling\n"
        response += "   - Often works with individuals, families, and groups\n"
        response += "   - May specialize in specific populations\n\n"
        
        response += "4. **Licensed Professional Counselor (LPC)**:\n"
        response += "   - Provides individual and group therapy\n"
        response += "   - Various specializations available\n"
        response += "   - Often more affordable than psychologists\n\n"
        
        response += "üîç **How to Find a Mental Health Professional**:\n\n"
        response += "‚Ä¢ **Insurance Provider Directory**:\n"
        response += "  - Check your insurance website for covered providers\n"
        response += "  - Call member services for assistance\n\n"
        
        response += "‚Ä¢ **Psychology Today**:\n"
        response += "  - psychologytoday.com\n"
        response += "  - Search by location, insurance, and specialization\n"
        response += "  - Read provider profiles and approaches\n\n"
        
        response += "‚Ä¢ **Your Primary Care Doctor**:\n"
        response += "  - Can provide referrals to trusted professionals\n"
        response += "  - May coordinate care between providers\n\n"
        
        response += "‚Ä¢ **Employee Assistance Program (EAP)**:\n"
        response += "  - Many employers offer free counseling sessions\n"
        response += "  - Check with HR about available resources\n\n"
        
        response += "üí∞ **Cost Considerations**:\n"
        response += "‚Ä¢ Check insurance coverage and copays\n"
        response += "‚Ä¢ Ask about sliding scale fees\n"
        response += "‚Ä¢ Community mental health centers often offer lower-cost options\n"
        response += "‚Ä¢ Some therapists offer payment plans\n\n"
        
        response += "‚ùì **Questions to Ask Potential Therapists**:\n"
        response += "‚Ä¢ What is your experience with my specific concerns?\n"
        response += "‚Ä¢ What therapeutic approaches do you use?\n"
        response += "‚Ä¢ What are your fees and payment options?\n"
        response += "‚Ä¢ How often would we meet?\n"
        response += "‚Ä¢ What should I expect from therapy?\n"
        
        tips = [
            "It's okay to 'shop around' for the right therapist",
            "The therapeutic relationship is crucial for success",
            "Don't give up if the first therapist isn't a good fit",
            "Be honest about your concerns and goals"
        ]
        
        next_steps = [
            "Check your insurance coverage for mental health",
            "Research therapists in your area",
            "Schedule initial consultations with 2-3 providers"
        ]
        
        return self.format_response(response, tips, next_steps)
    
    async def _provide_medical_referrals(self, message: str, context: UserSessionContext) -> str:
        """Provide medical professional referrals"""
        response = "üè• Medical Professional Referrals\n\n"
        
        response += "‚ö†Ô∏è **Important**: This AI system cannot diagnose medical conditions or replace professional medical advice.\n\n"
        
        response += "üë®‚Äç‚öïÔ∏è **When to See Your Primary Care Doctor**:\n"
        response += "‚Ä¢ Annual wellness checkups\n"
        response += "‚Ä¢ New or concerning symptoms\n"
        response += "‚Ä¢ Chronic condition management\n"
        response += "‚Ä¢ Medication reviews\n"
        response += "‚Ä¢ Referrals to specialists\n"
        response += "‚Ä¢ Health screenings and preventive care\n\n"
        
        response += "ü©∫ **Specialists You Might Need**:\n\n"
        response += "**For Weight Management**:\n"
        response += "‚Ä¢ Endocrinologist (hormone-related weight issues)\n"
        response += "‚Ä¢ Bariatric surgeon (surgical weight loss options)\n"
        response += "‚Ä¢ Registered dietitian (nutrition counseling)\n\n"
        
        response += "**For Fitness-Related Issues**:\n"
        response += "‚Ä¢ Sports medicine physician\n"
        response += "‚Ä¢ Physical therapist\n"
        response += "‚Ä¢ Orthopedic surgeon (for injuries)\n\n"
        
        response += "**For Mental Health**:\n"
        response += "‚Ä¢ Psychiatrist (medication management)\n"
        response += "‚Ä¢ Neurologist (if neurological symptoms)\n\n"
        
        response += "üîç **How to Find Medical Professionals**:\n\n"
        response += "‚Ä¢ **Insurance Provider Directory**\n"
        response += "‚Ä¢ **Hospital System Websites**\n"
        response += "‚Ä¢ **State Medical Board Directories**\n"
        response += "‚Ä¢ **Referrals from Current Doctors**\n"
        response += "‚Ä¢ **Healthgrades.com or similar rating sites**\n\n"
        
        response += "üìã **Preparing for Medical Appointments**:\n"
        response += "‚Ä¢ List current symptoms and when they started\n"
        response += "‚Ä¢ Bring current medications and supplements\n"
        response += "‚Ä¢ Prepare questions in advance\n"
        response += "‚Ä¢ Bring insurance cards and ID\n"
        response += "‚Ä¢ Consider bringing a support person\n\n"
        
        response += "üö® **When to Seek Immediate Medical Care**:\n"
        response += "‚Ä¢ Chest pain or difficulty breathing\n"
        response += "‚Ä¢ Severe abdominal pain\n"
        response += "‚Ä¢ Signs of stroke (FAST: Face, Arms, Speech, Time)\n"
        response += "‚Ä¢ Severe allergic reactions\n"
        response += "‚Ä¢ High fever with concerning symptoms\n"
        response += "‚Ä¢ Any situation where you feel something is seriously wrong\n"
        
        tips = [
            "Don't hesitate to seek medical care when concerned",
            "Keep a health journal to track symptoms",
            "Be honest with healthcare providers about all symptoms",
            "Ask questions if you don't understand something"
        ]
        
        next_steps = [
            "Schedule a wellness checkup if overdue",
            "Research specialists if needed",
            "Prepare questions for your next appointment"
        ]
        
        return self.format_response(response, tips, next_steps)
    
    async def _provide_nutrition_referrals(self, message: str, context: UserSessionContext) -> str:
        """Provide nutrition professional referrals"""
        response = "ü•ó Nutrition Professional Referrals\n\n"
        
        response += "üë©‚Äç‚öïÔ∏è **Types of Nutrition Professionals**:\n\n"
        response += "1. **Registered Dietitian Nutritionist (RDN)**:\n"
        response += "   - Nationally credentialed nutrition expert\n"
        response += "   - Completed accredited education and internship\n"
        response += "   - Can provide medical nutrition therapy\n"
        response += "   - Often covered by insurance\n\n"
        
        response += "2. **Certified Nutrition Specialist (CNS)**:\n"
        response += "   - Advanced degree in nutrition\n"
        response += "   - Board certification in nutrition\n"
        response += "   - Focus on personalized nutrition approaches\n\n"
        
        response += "3. **Certified Nutritionist**:\n"
        response += "   - Varies by state (some states don't regulate this title)\n"
        response += "   - Check credentials and education carefully\n"
        response += "   - May not be covered by insurance\n\n"
        
        response += "üéØ **When to See a Nutrition Professional**:\n"
        response += "‚Ä¢ Weight management goals\n"
        response += "‚Ä¢ Medical conditions requiring dietary changes\n"
        response += "‚Ä¢ Food allergies or intolerances\n"
        response += "‚Ä¢ Eating disorders (with specialized training)\n"
        response += "‚Ä¢ Sports nutrition needs\n"
        response += "‚Ä¢ Digestive issues\n"
        response += "‚Ä¢ Pregnancy and breastfeeding nutrition\n\n"
        
        response += "üîç **How to Find a Qualified Professional**:\n\n"
        response += "‚Ä¢ **Academy of Nutrition and Dietetics**: eatright.org\n"
        response += "  - 'Find an Expert' tool\n"
        response += "  - Search by location and specialty\n\n"
        
        response += "‚Ä¢ **Insurance Provider Directory**\n"
        response += "  - Many insurance plans cover RDN services\n"
        response += "  - May require physician referral\n\n"
        
        response += "‚Ä¢ **Hospital and Medical Center Websites**\n"
        response += "  - Many have outpatient nutrition services\n\n"
        
        response += "‚Ä¢ **Your Doctor's Referral**\n"
        response += "  - Primary care or specialist referral\n"
        response += "  - May be required for insurance coverage\n\n"
        
        response += "üí∞ **Cost and Insurance**:\n"
        response += "‚Ä¢ Many insurance plans cover RDN services\n"
        response += "‚Ä¢ Medical nutrition therapy often covered for certain conditions\n"
        response += "‚Ä¢ Ask about sliding scale fees\n"
        response += "‚Ä¢ Some employers offer nutrition counseling benefits\n\n"
        
        response += "üìã **What to Expect**:\n"
        response += "‚Ä¢ Comprehensive nutrition assessment\n"
        response += "‚Ä¢ Personalized meal planning\n"
        response += "‚Ä¢ Education about nutrition and health\n"
        response += "‚Ä¢ Ongoing support and monitoring\n"
        response += "‚Ä¢ Coordination with other healthcare providers\n"
        
        tips = [
            "Look for RDN credential for most reliable expertise",
            "Ask about their experience with your specific needs",
            "Check if your insurance covers nutrition counseling",
            "Be prepared to discuss your complete health history"
        ]
        
        next_steps = [
            "Check insurance coverage for nutrition services",
            "Get a referral from your doctor if needed",
            "Research RDNs in your area with relevant specialties"
        ]
        
        return self.format_response(response, tips, next_steps)
    
    async def _provide_fitness_referrals(self, message: str, context: UserSessionContext) -> str:
        """Provide fitness professional referrals"""
        response = "üèãÔ∏è‚Äç‚ôÄÔ∏è Fitness Professional Referrals\n\n"
        
        response += "üí™ **Types of Fitness Professionals**:\n\n"
        response += "1. **Certified Personal Trainer**:\n"
        response += "   - One-on-one or small group training\n"
        response += "   - Customized workout programs\n"
        response += "   - Form correction and motivation\n"
        response += "   - Look for certifications: NASM, ACSM, ACE, NSCA\n\n"
        
        response += "2. **Exercise Physiologist**:\n"
        response += "   - Advanced degree in exercise science\n"
        response += "   - Specializes in exercise for medical conditions\n"
        response += "   - Often works in clinical settings\n\n"
        
        response += "3. **Physical Therapist**:\n"
        response += "   - Licensed healthcare professional\n"
        response += "   - Specializes in injury recovery and prevention\n"
        response += "   - Can address movement dysfunctions\n\n"
        
        response += "4. **Group Fitness Instructor**:\n"
        response += "   - Leads classes in various formats\n"
        response += "   - More affordable than personal training\n"
        response += "   - Good for motivation and community\n\n"
        
        response += "üéØ **When to Work with a Fitness Professional**:\n"
        response += "‚Ä¢ New to exercise or returning after long break\n"
        response += "‚Ä¢ Specific fitness goals (strength, endurance, sport)\n"
        response += "‚Ä¢ Injury history or physical limitations\n"
        response += "‚Ä¢ Plateau in current fitness routine\n"
        response += "‚Ä¢ Need motivation and accountability\n"
        response += "‚Ä¢ Want to learn proper form and technique\n\n"
        
        response += "üîç **How to Find Qualified Professionals**:\n\n"
        response += "‚Ä¢ **Local Gyms and Fitness Centers**\n"
        response += "  - Many have certified trainers on staff\n"
        response += "  - Can often try a session before committing\n\n"
        
        response += "‚Ä¢ **Professional Organization Directories**:\n"
        response += "  - NASM: nasm.org\n"
        response += "  - ACSM: acsm.org\n"
        response += "  - ACE: acefitness.org\n"
        response += "  - NSCA: nsca.com\n\n"
        
        response += "‚Ä¢ **Online Platforms**:\n"
        response += "  - Thumbtack, ClassPass, Trainiac\n"
        response += "  - Read reviews and check credentials\n\n"
        
        response += "‚Ä¢ **Referrals**:\n"
        response += "  - Ask friends, family, or healthcare providers\n"
        response += "  - Check with local sports medicine clinics\n\n"
        
        response += "üí∞ **Cost Considerations**:\n"
        response += "‚Ä¢ Personal training: $30-100+ per session\n"
        response += "‚Ä¢ Group classes: $15-30 per class\n"
        response += "‚Ä¢ Package deals often reduce per-session cost\n"
        response += "‚Ä¢ Some insurance plans cover exercise therapy\n"
        response += "‚Ä¢ Community centers may offer lower-cost options\n\n"
        
        response += "‚ùì **Questions to Ask Potential Trainers**:\n"
        response += "‚Ä¢ What certifications do you hold?\n"
        response += "‚Ä¢ What's your experience with my goals/conditions?\n"
        response += "‚Ä¢ What's your training philosophy?\n"
        response += "‚Ä¢ Can you provide references?\n"
        response += "‚Ä¢ What are your rates and cancellation policy?\n"
        response += "‚Ä¢ How do you track progress?\n"
        
        tips = [
            "Look for nationally recognized certifications",
            "Ask for a consultation or trial session",
            "Make sure their personality and style fit you",
            "Check that they carry liability insurance"
        ]
        
        next_steps = [
            "Research certified trainers in your area",
            "Schedule consultations with 2-3 candidates",
            "Ask about their experience with your specific goals"
        ]
        
        return self.format_response(response, tips, next_steps)
    
    async def _handle_general_human_support(self, message: str, context: UserSessionContext) -> str:
        """Handle general requests for human support"""
        response = f"ü§ù Human Support & Professional Resources\n\n"
        
        response += f"Hello {context.user_name}! I understand you'd like to connect with human professionals. "
        response += "That's a great step in your health and wellness journey.\n\n"
        
        response += "üë• **Types of Human Support Available**:\n\n"
        response += "üß† **Mental Health Professionals**:\n"
        response += "‚Ä¢ Therapists and counselors\n"
        response += "‚Ä¢ Psychiatrists for medication management\n"
        response += "‚Ä¢ Crisis counselors for immediate support\n\n"
        
        response += "üè• **Medical Professionals**:\n"
        response += "‚Ä¢ Primary care physicians\n"
        response += "‚Ä¢ Specialists for specific conditions\n"
        response += "‚Ä¢ Preventive care providers\n\n"
        
        response += "ü•ó **Nutrition Professionals**:\n"
        response += "‚Ä¢ Registered Dietitian Nutritionists (RDNs)\n"
        response += "‚Ä¢ Certified Nutrition Specialists\n"
        response += "‚Ä¢ Medical nutrition therapists\n\n"
        
        response += "üèãÔ∏è‚Äç‚ôÄÔ∏è **Fitness Professionals**:\n"
        response += "‚Ä¢ Certified personal trainers\n"
        response += "‚Ä¢ Exercise physiologists\n"
        response += "‚Ä¢ Physical therapists\n\n"
        
        response += "üéØ **Why Human Support is Valuable**:\n"
        response += "‚Ä¢ Personalized assessment and care\n"
        response += "‚Ä¢ Professional expertise and credentials\n"
        response += "‚Ä¢ Accountability and ongoing support\n"
        response += "‚Ä¢ Ability to address complex or serious issues\n"
        response += "‚Ä¢ Integration with your overall healthcare\n\n"
        
        response += "üîç **Getting Started**:\n"
        response += "1. **Identify Your Needs**: What type of support do you need most?\n"
        response += "2. **Check Insurance**: What professionals are covered?\n"
        response += "3. **Get Referrals**: Ask your doctor or trusted friends\n"
        response += "4. **Research Credentials**: Verify professional qualifications\n"
        response += "5. **Schedule Consultations**: Meet with potential providers\n\n"
        
        response += "üí° **Remember**:\n"
        response += "‚Ä¢ Seeking professional help is a sign of strength\n"
        response += "‚Ä¢ It's okay to 'shop around' for the right fit\n"
        response += "‚Ä¢ Many professionals offer initial consultations\n"
        response += "‚Ä¢ You can continue using AI support alongside human professionals\n"
        
        tips = [
            "Don't wait until problems become severe to seek help",
            "Professional support can accelerate your progress",
            "The right professional relationship can be life-changing",
            "Many issues are best addressed with human expertise"
        ]
        
        next_steps = [
            "Identify which type of professional you need most",
            "Check your insurance coverage and benefits",
            "Ask me for specific referral guidance in any area"
        ]
        
        return self.format_response(response, tips, next_steps)
    
    def get_capabilities(self) -> List[str]:
        """Return agent capabilities"""
        return self.capabilities
